<!DOCTYPE html>
<html leng="en">
    <head>
        <meta charset="UTF-8">
        <title>test-frontend</title>
        <!--Phaser 3 CDN-->
        <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
                background: #d5d5d5;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                height: 100vh;
            }
            canvas {
                border: 2px solid #fff;
            }
        </style>
    </head>
    <h2>WebSocket Test</h2>
    <input id="user_id" type="text" placeholder="User ID"><br>
    <input id="user_name" type="text" placeholder="User Name">
    <div id="log_button">
            <button onclick="login()">Login</button>
    </div>
    <div id="login_user_info"></div><br>

    <input id="input" type="text" placeholder="Input Text">
    <button onclick="sendMessage()">Send</button>
    <div id="log"></div>

    <script>
        //const ws=new WebSocket(`ws://${location.host}/api/ws`);
        let ws=null;
        let user_id;
        let user_name;
        function createWebSocket(){
            if(ws){
                ws.close();
            }

            ws=new WebSocket(`ws://${location.host}/api/ws`);
            ws.onopen=()=>{
                const login_info=document.getElementById("login_user_info");
                login_info.innerHTML="<p>"+"Logged-in User ID: "+user_id+", Name: "+user_name+"</p>";
                ws.send(user_id);
                console.log("WebSocket Connect");
            }
            ws.onmessage=(event)=>{
                const log=document.getElementById("log");
                log.innerHTML+="<p>"+event.data+"</p>";
                console.log("Server back : ",event.data);
            }
            ws.onerror = (err) => {
                console.error("WS error", err);
            };
            ws.onclose=()=>{
                user_id="";
                user_name="";
                console.log("WebSocket Disconnect");
            }
        }
        function sendMessage(){
            if(ws.readyState!==WebSocket.OPEN){
                console.error("WebSocket not open:",ws.readyState);
                return;
            }
            const input=document.getElementById("input");
            ws.send(user_name+": "+input.value);
            console.log("Send : ",input.value+"\n");
            input.value="";
        }

        async function login(){
            const id_input=document.getElementById("user_id");
            const name_input=document.getElementById("user_name");

            id=id_input.value;
            name=name_input.value,
            console.log("input Id: "+id,"input name: "+name);

            const res=await fetch("/api/login",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({user_id:id,user_name:name})
            });
            const res_data=await res.json();
            if(res_data.ok===true){
                user_id=res_data.user_id;
                user_name=res_data.user_name;
                createWebSocket();

                id_input.value="";
                name_input.value="";
                const log_button=document.getElementById("log_button");
                log_button.innerHTML="<button onclick='logout()'>Logout</button>";
            }
        }
        async function logout(){
            if(ws==null){
                return;
            }

            const res=await fetch("/api/logout",{
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({user_id:id})
            });
            const res_data=await res.json();
            if(res_data.ok===true){
                ws.close();
                const log_button=document.getElementById("log_button");
                log_button.innerHTML="<button onclick='login()'>Login</button>";
                const login_info=document.getElementById("login_user_info");
                login_info.innerHTML="";
            }
        }
    </script>

    <!--<script>
         // Phaser config
        const config = {
            type: Phaser.AUTO,
            width: 600,
            height: 400,
            backgroundColor: 0x333333,
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
        const game = new Phaser.Game(config);

        let player;

        function preload() {
            // LoadAsset
        }

        function create() {
            // Create A White Block
            player = this.add.rectangle(300, 200, 50, 50, 0xffffff);

            // ArrowKey
            this.cursors = this.input.keyboard.createCursorKeys();
        }

        function update() {
            const speed = 3;
            if (this.cursors.left.isDown) {
                player.x -= speed;
            }
            if (this.cursors.right.isDown) {
                player.x += speed;
            }
            if (this.cursors.up.isDown) {
                player.y -= speed;
            }
            if (this.cursors.down.isDown) {
                player.y += speed;
            }
        }
    </script>-->
</html>